<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stock Chart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #1a1a2e;
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        .header {
            padding: 10px 16px;
            background: #16213e;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #0f3460;
        }

        .stock-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
        }

        .stock-code {
            font-size: 14px;
            color: #888;
        }

        .stock-price {
            font-size: 20px;
            font-weight: 600;
        }

        .stock-change {
            font-size: 14px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .up {
            color: #ef5350;
            background: rgba(239, 83, 80, 0.15);
        }

        .down {
            color: #26a69a;
            background: rgba(38, 166, 154, 0.15);
        }

        .flat {
            color: #888;
            background: rgba(136, 136, 136, 0.15);
        }

        .toolbar {
            padding: 6px 16px;
            background: #16213e;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #0f3460;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 4px 10px;
            font-size: 12px;
            background: #2a2a4e;
            border: 1px solid #3a3a6e;
            color: #aaa;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #3a3a6e;
            color: #fff;
        }

        .toolbar-btn.active {
            background: #4a4a8e;
            border-color: #6a6aae;
            color: #fff;
        }

        .toolbar-divider {
            width: 1px;
            background: #3a3a6e;
            margin: 0 4px;
        }

        #chart-container {
            width: 100%;
            height: calc(100vh - 100px);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: #888;
        }

        .error {
            color: #ef5350;
            text-align: center;
            padding: 20px;
        }

        .legend {
            position: absolute;
            top: 110px;
            left: 16px;
            font-size: 11px;
            color: #888;
            background: rgba(26, 26, 46, 0.95);
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 10;
            max-width: 300px;
        }

        .legend-row {
            display: flex;
            gap: 12px;
            margin-bottom: 3px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            gap: 3px;
        }

        .legend-label {
            color: #666;
        }

        .legend-value {
            color: #fff;
            font-weight: 500;
        }

        .ma5 {
            color: #ffd700;
        }

        .ma10 {
            color: #ff69b4;
        }

        .ma20 {
            color: #00bfff;
        }

        .ma60 {
            color: #9370db;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="stock-info">
            <span class="stock-name" id="stockName">--</span>
            <span class="stock-code" id="stockCode">--</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px;">
            <span class="stock-price" id="stockPrice">--</span>
            <span class="stock-change flat" id="stockChange">--</span>
        </div>
    </div>
    <div class="toolbar">
        <button class="toolbar-btn active" id="btnMA" onclick="toggleMA()">MA</button>
        <button class="toolbar-btn" id="btnBOLL" onclick="toggleBOLL()">BOLL</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn active" id="btnVol" onclick="toggleVolume()">VOL</button>
        <button class="toolbar-btn" id="btnMACD" onclick="toggleMACD()">MACD</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn" onclick="setDays(30)">30D</button>
        <button class="toolbar-btn active" onclick="setDays(60)">60D</button>
        <button class="toolbar-btn" onclick="setDays(120)">120D</button>
    </div>
    <div id="chart-container">
        <div class="loading" id="loading">加载中...</div>
    </div>
    <div class="legend" id="legend" style="display: none;">
        <div class="legend-row">
            <div class="legend-item"><span class="legend-label">O:</span><span class="legend-value" id="legO">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">H:</span><span class="legend-value" id="legH">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">L:</span><span class="legend-value" id="legL">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">C:</span><span class="legend-value" id="legC">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">Vol:</span><span class="legend-value"
                    id="legVol">--</span></div>
        </div>
        <div class="legend-row" id="maLegend">
            <div class="legend-item"><span class="legend-label ma5">MA5:</span><span class="legend-value ma5"
                    id="legMA5">--</span></div>
            <div class="legend-item"><span class="legend-label ma10">MA10:</span><span class="legend-value ma10"
                    id="legMA10">--</span></div>
            <div class="legend-item"><span class="legend-label ma20">MA20:</span><span class="legend-value ma20"
                    id="legMA20">--</span></div>
            <div class="legend-item"><span class="legend-label ma60">MA60:</span><span class="legend-value ma60"
                    id="legMA60">--</span></div>
        </div>
        <div class="legend-row" id="bollLegend" style="display: none;">
            <div class="legend-item"><span class="legend-label" style="color:#ff9800">UPPER:</span><span
                    class="legend-value" id="legBollUp">--</span></div>
            <div class="legend-item"><span class="legend-label" style="color:#2196f3">MID:</span><span
                    class="legend-value" id="legBollMid">--</span></div>
            <div class="legend-item"><span class="legend-label" style="color:#4caf50">LOWER:</span><span
                    class="legend-value" id="legBollLow">--</span></div>
        </div>
    </div>

    <script>
        // Get stock code from URL params
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code') || '600519';
        let currentDays = parseInt(params.get('days')) || 60;

        // API base URL (same origin)
        const API_BASE = window.location.origin;

        let chart, candleSeries, volumeSeries;
        let ma5Series, ma10Series, ma20Series, ma60Series;
        let bollUpperSeries, bollMidSeries, bollLowerSeries;
        let rawData = [];

        // State
        let showMA = true;
        let showBOLL = false;
        let showVolume = true;
        let showMACD = false;

        // Calculate Moving Average
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push({ time: data[i].time, value: null });
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j].close;
                    }
                    result.push({ time: data[i].time, value: sum / period });
                }
            }
            return result.filter(d => d.value !== null);
        }

        // Calculate Bollinger Bands (20-day, 2 std)
        function calculateBOLL(data, period = 20, multiplier = 2) {
            const upper = [], mid = [], lower = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) continue;

                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                const avg = sum / period;

                let variance = 0;
                for (let j = 0; j < period; j++) {
                    variance += Math.pow(data[i - j].close - avg, 2);
                }
                const std = Math.sqrt(variance / period);

                mid.push({ time: data[i].time, value: avg });
                upper.push({ time: data[i].time, value: avg + multiplier * std });
                lower.push({ time: data[i].time, value: avg - multiplier * std });
            }
            return { upper, mid, lower };
        }

        async function loadChart() {
            try {
                const response = await fetch(`${API_BASE}/api/chart/data/${code}?days=${currentDays + 60}`);
                if (!response.ok) throw new Error('Failed to load data');

                const result = await response.json();

                if (!result.data || result.data.length === 0) {
                    throw new Error('No data available');
                }

                rawData = result.data;

                // Update header
                document.getElementById('stockName').textContent = result.name || code;
                document.getElementById('stockCode').textContent = code;

                // Get latest price info
                const latest = rawData[rawData.length - 1];
                const prev = rawData.length > 1 ? rawData[rawData.length - 2] : latest;
                const change = ((latest.close - prev.close) / prev.close * 100);

                document.getElementById('stockPrice').textContent = latest.close.toFixed(2);
                const changeEl = document.getElementById('stockChange');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeEl.className = `stock-change ${change > 0 ? 'up' : change < 0 ? 'down' : 'flat'}`;

                // Hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('legend').style.display = 'block';

                // Create chart
                const container = document.getElementById('chart-container');
                if (chart) chart.remove();

                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: {
                        background: { color: '#1a1a2e' },
                        textColor: '#888',
                    },
                    grid: {
                        vertLines: { color: '#2a2a4e' },
                        horzLines: { color: '#2a2a4e' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#2a2a4e',
                    },
                    timeScale: {
                        borderColor: '#2a2a4e',
                        timeVisible: true,
                    },
                });

                // Candlestick series
                candleSeries = chart.addCandlestickSeries({
                    upColor: '#ef5350',
                    downColor: '#26a69a',
                    borderUpColor: '#ef5350',
                    borderDownColor: '#26a69a',
                    wickUpColor: '#ef5350',
                    wickDownColor: '#26a69a',
                });

                // Volume series
                volumeSeries = chart.addHistogramSeries({
                    color: '#26a69a',
                    priceFormat: { type: 'volume' },
                    priceScaleId: 'volume',
                    scaleMargins: { top: 0.85, bottom: 0 },
                });

                // MA series
                ma5Series = chart.addLineSeries({ color: '#ffd700', lineWidth: 1, priceScaleId: 'right' });
                ma10Series = chart.addLineSeries({ color: '#ff69b4', lineWidth: 1, priceScaleId: 'right' });
                ma20Series = chart.addLineSeries({ color: '#00bfff', lineWidth: 1, priceScaleId: 'right' });
                ma60Series = chart.addLineSeries({ color: '#9370db', lineWidth: 1, priceScaleId: 'right' });

                // BOLL series
                bollUpperSeries = chart.addLineSeries({ color: '#ff9800', lineWidth: 1, priceScaleId: 'right', lineStyle: 2 });
                bollMidSeries = chart.addLineSeries({ color: '#2196f3', lineWidth: 1, priceScaleId: 'right' });
                bollLowerSeries = chart.addLineSeries({ color: '#4caf50', lineWidth: 1, priceScaleId: 'right', lineStyle: 2 });

                // Set data
                updateChartData();

                // Crosshair move handler
                chart.subscribeCrosshairMove(handleCrosshair);

                // Fit content
                chart.timeScale().fitContent();

                // Resize handler
                window.addEventListener('resize', () => {
                    chart.resize(container.clientWidth, container.clientHeight);
                });

            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="error">❌ ${error.message}</div>`;
            }
        }

        function updateChartData() {
            // Slice data to current days (use last N days)
            const displayData = rawData.slice(-currentDays);

            const candleData = displayData.map(d => ({
                time: d.time,
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close,
            }));

            const volumeData = displayData.map(d => ({
                time: d.time,
                value: d.volume,
                color: d.close >= d.open ? 'rgba(239,83,80,0.5)' : 'rgba(38,166,154,0.5)',
            }));

            candleSeries.setData(candleData);

            // Volume
            if (showVolume) {
                volumeSeries.setData(volumeData);
            } else {
                volumeSeries.setData([]);
            }

            // MA indicators (calculated on full data for accuracy)
            if (showMA) {
                ma5Series.setData(calculateMA(rawData, 5).slice(-currentDays));
                ma10Series.setData(calculateMA(rawData, 10).slice(-currentDays));
                ma20Series.setData(calculateMA(rawData, 20).slice(-currentDays));
                ma60Series.setData(calculateMA(rawData, 60).slice(-currentDays));
                document.getElementById('maLegend').style.display = 'flex';
            } else {
                ma5Series.setData([]);
                ma10Series.setData([]);
                ma20Series.setData([]);
                ma60Series.setData([]);
                document.getElementById('maLegend').style.display = 'none';
            }

            // BOLL
            if (showBOLL) {
                const boll = calculateBOLL(rawData);
                bollUpperSeries.setData(boll.upper.slice(-currentDays));
                bollMidSeries.setData(boll.mid.slice(-currentDays));
                bollLowerSeries.setData(boll.lower.slice(-currentDays));
                document.getElementById('bollLegend').style.display = 'flex';
            } else {
                bollUpperSeries.setData([]);
                bollMidSeries.setData([]);
                bollLowerSeries.setData([]);
                document.getElementById('bollLegend').style.display = 'none';
            }

            chart.timeScale().fitContent();
        }

        function handleCrosshair(param) {
            if (!param.time || !param.seriesData) return;

            const candle = param.seriesData.get(candleSeries);
            const vol = param.seriesData.get(volumeSeries);

            if (candle) {
                document.getElementById('legO').textContent = candle.open?.toFixed(2) || '--';
                document.getElementById('legH').textContent = candle.high?.toFixed(2) || '--';
                document.getElementById('legL').textContent = candle.low?.toFixed(2) || '--';
                document.getElementById('legC').textContent = candle.close?.toFixed(2) || '--';
            }
            if (vol) {
                document.getElementById('legVol').textContent = formatVolume(vol.value);
            }

            // MA values
            if (showMA) {
                const ma5 = param.seriesData.get(ma5Series);
                const ma10 = param.seriesData.get(ma10Series);
                const ma20 = param.seriesData.get(ma20Series);
                const ma60 = param.seriesData.get(ma60Series);
                document.getElementById('legMA5').textContent = ma5?.value?.toFixed(2) || '--';
                document.getElementById('legMA10').textContent = ma10?.value?.toFixed(2) || '--';
                document.getElementById('legMA20').textContent = ma20?.value?.toFixed(2) || '--';
                document.getElementById('legMA60').textContent = ma60?.value?.toFixed(2) || '--';
            }

            // BOLL values
            if (showBOLL) {
                const bu = param.seriesData.get(bollUpperSeries);
                const bm = param.seriesData.get(bollMidSeries);
                const bl = param.seriesData.get(bollLowerSeries);
                document.getElementById('legBollUp').textContent = bu?.value?.toFixed(2) || '--';
                document.getElementById('legBollMid').textContent = bm?.value?.toFixed(2) || '--';
                document.getElementById('legBollLow').textContent = bl?.value?.toFixed(2) || '--';
            }
        }

        function toggleMA() {
            showMA = !showMA;
            document.getElementById('btnMA').classList.toggle('active', showMA);
            updateChartData();
        }

        function toggleBOLL() {
            showBOLL = !showBOLL;
            document.getElementById('btnBOLL').classList.toggle('active', showBOLL);
            updateChartData();
        }

        function toggleVolume() {
            showVolume = !showVolume;
            document.getElementById('btnVol').classList.toggle('active', showVolume);
            updateChartData();
        }

        function toggleMACD() {
            showMACD = !showMACD;
            document.getElementById('btnMACD').classList.toggle('active', showMACD);
            // MACD requires separate pane - TODO for future
            alert('MACD indicator coming soon!');
        }

        function setDays(days) {
            currentDays = days;
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                if (btn.textContent.includes('D')) {
                    btn.classList.toggle('active', btn.textContent === days + 'D');
                }
            });
            updateChartData();
        }

        function formatVolume(vol) {
            if (vol >= 100000000) return (vol / 100000000).toFixed(2) + '亿';
            if (vol >= 10000) return (vol / 10000).toFixed(0) + '万';
            return vol.toString();
        }

        // Initialize
        loadChart();

        // Telegram WebApp integration
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }
    </script>
</body>

</html>