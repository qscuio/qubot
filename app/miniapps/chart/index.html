<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stock Chart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf1;
            --text-primary: #1a1a2e;
            --text-secondary: #666;
            --text-muted: #888;
            --border-color: #d1d5db;
            --btn-bg: #e5e7eb;
            --btn-border: #d1d5db;
            --btn-text: #555;
            --btn-hover-bg: #d1d5db;
            --btn-active-bg: #3b82f6;
            --btn-active-border: #2563eb;
            --btn-active-text: #fff;
            --chart-bg: #ffffff;
            --chart-grid: #e5e7eb;
            --legend-bg: rgba(255, 255, 255, 0.95);
            --up-color: #ef4444;
            --down-color: #22c55e;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #475569;
            --btn-bg: #334155;
            --btn-border: #475569;
            --btn-text: #94a3b8;
            --btn-hover-bg: #475569;
            --btn-active-bg: #3b82f6;
            --btn-active-border: #60a5fa;
            --btn-active-text: #fff;
            --chart-bg: #0f172a;
            --chart-grid: #1e293b;
            --legend-bg: rgba(15, 23, 42, 0.95);
            --up-color: #ef4444;
            --down-color: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            padding: 8px 12px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .stock-info {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .stock-name {
            font-size: 16px;
            font-weight: 600;
        }

        .stock-code {
            font-size: 12px;
            color: var(--text-muted);
        }

        .stock-price {
            font-size: 18px;
            font-weight: 600;
        }

        .stock-change {
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .up {
            color: var(--up-color);
            background: rgba(239, 68, 68, 0.15);
        }

        .down {
            color: var(--down-color);
            background: rgba(34, 197, 94, 0.15);
        }

        .flat {
            color: var(--text-muted);
            background: rgba(136, 136, 136, 0.15);
        }

        .toolbar {
            padding: 4px 12px;
            background: var(--bg-secondary);
            display: flex;
            gap: 6px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-btn {
            padding: 3px 8px;
            font-size: 11px;
            background: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--btn-hover-bg);
        }

        .toolbar-btn.active {
            background: var(--btn-active-bg);
            border-color: var(--btn-active-border);
            color: var(--btn-active-text);
        }

        .toolbar-divider {
            width: 1px;
            height: 16px;
            background: var(--border-color);
            margin: 0 2px;
        }

        .theme-btn {
            padding: 3px 6px;
            font-size: 12px;
            background: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            border-radius: 4px;
            cursor: pointer;
            margin-left: auto;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .charts-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        #kline-container {
            flex: 3;
            min-height: 0;
            position: relative;
        }

        #volume-container {
            flex: 1;
            min-height: 60px;
            border-top: 1px solid var(--border-color);
        }

        .chip-panel {
            width: 120px;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .chip-header {
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .chip-date {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        #chip-chart {
            flex: 1;
            padding: 4px;
            overflow: hidden;
        }

        .chip-bar-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .chip-bar-row {
            display: flex;
            align-items: center;
            font-size: 9px;
            height: 14px;
        }

        .chip-price {
            width: 40px;
            text-align: right;
            padding-right: 4px;
            color: var(--text-muted);
            font-size: 8px;
        }

        .chip-bar-wrapper {
            flex: 1;
            height: 10px;
            background: var(--bg-tertiary);
            position: relative;
            border-radius: 2px;
            overflow: hidden;
        }

        .chip-bar {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        .chip-bar.profit {
            background: var(--up-color);
        }

        .chip-bar.loss {
            background: var(--down-color);
        }

        .legend {
            position: absolute;
            top: 4px;
            left: 8px;
            font-size: 10px;
            color: var(--text-muted);
            background: var(--legend-bg);
            padding: 4px 8px;
            border-radius: 4px;
            z-index: 10;
            border: 1px solid var(--border-color);
        }

        .legend-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            gap: 2px;
        }

        .legend-label {
            color: var(--text-muted);
        }

        .legend-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .ma5 {
            color: #fbbf24;
        }

        .ma10 {
            color: #ec4899;
        }

        .ma20 {
            color: #3b82f6;
        }

        .ma60 {
            color: #a855f7;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 14px;
            color: var(--text-muted);
        }

        .error {
            color: var(--up-color);
            text-align: center;
            padding: 20px;
        }

        .chip-stats {
            padding: 4px 8px;
            font-size: 9px;
            border-top: 1px solid var(--border-color);
        }

        .chip-stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .chip-stat-label {
            color: var(--text-muted);
        }

        .chip-stat-value {
            font-weight: 500;
        }

        .chip-stat-value.profit {
            color: var(--up-color);
        }

        .chip-stat-value.loss {
            color: var(--down-color);
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="stock-info">
            <span class="stock-name" id="stockName">--</span>
            <span class="stock-code" id="stockCode">--</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 6px;">
            <span class="stock-price" id="stockPrice">--</span>
            <span class="stock-change flat" id="stockChange">--</span>
        </div>
    </div>
    <div class="toolbar">
        <button class="toolbar-btn active" id="btnDaily" onclick="setPeriod('daily')">Êó•K</button>
        <button class="toolbar-btn" id="btnWeekly" onclick="setPeriod('weekly')">Âë®K</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn active" id="btnMA" onclick="toggleMA()">MA</button>
        <button class="toolbar-btn" id="btnBOLL" onclick="toggleBOLL()">BOLL</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn active" id="btnSignals" onclick="toggleSignals()">‰ø°Âè∑</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn" onclick="setDays(30)">30</button>
        <button class="toolbar-btn active" onclick="setDays(60)">60</button>
        <button class="toolbar-btn" onclick="setDays(120)">120</button>
        <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
    </div>

    <div class="main-container">
        <div class="charts-container">
            <div id="kline-container">
                <div class="loading" id="loading">Âä†ËΩΩ‰∏≠...</div>
                <div class="legend" id="legend" style="display: none;">
                    <div class="legend-row">
                        <div class="legend-item"><span class="legend-label">O:</span><span class="legend-value"
                                id="legO">--</span></div>
                        <div class="legend-item"><span class="legend-label">H:</span><span class="legend-value"
                                id="legH">--</span></div>
                        <div class="legend-item"><span class="legend-label">L:</span><span class="legend-value"
                                id="legL">--</span></div>
                        <div class="legend-item"><span class="legend-label">C:</span><span class="legend-value"
                                id="legC">--</span></div>
                    </div>
                    <div class="legend-row" id="maLegend">
                        <div class="legend-item"><span class="legend-label ma5">MA5:</span><span
                                class="legend-value ma5" id="legMA5">--</span></div>
                        <div class="legend-item"><span class="legend-label ma10">MA10:</span><span
                                class="legend-value ma10" id="legMA10">--</span></div>
                        <div class="legend-item"><span class="legend-label ma20">MA20:</span><span
                                class="legend-value ma20" id="legMA20">--</span></div>
                    </div>
                </div>
            </div>
            <div id="volume-container"></div>
        </div>
        <div class="chip-panel">
            <div class="chip-header">
                Á≠πÁ†ÅÂàÜÂ∏É
                <div class="chip-date" id="chipDate">--</div>
            </div>
            <div id="chip-chart"></div>
            <div class="chip-stats">
                <div class="chip-stat-row">
                    <span class="chip-stat-label">Ëé∑Âà©ÊØî‰æã</span>
                    <span class="chip-stat-value profit" id="profitRatio">--%</span>
                </div>
                <div class="chip-stat-row">
                    <span class="chip-stat-label">Âπ≥ÂùáÊàêÊú¨</span>
                    <span class="chip-stat-value" id="avgCost">--</span>
                </div>
                <div class="chip-stat-row">
                    <span class="chip-stat-label">ÈõÜ‰∏≠Â∫¶</span>
                    <span class="chip-stat-value" id="concentration">--%</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code') || '600519';
        let currentDays = parseInt(params.get('days')) || 60;
        let currentPeriod = params.get('period') || 'daily';
        const API_BASE = window.location.origin;

        let klineChart, volumeChart, candleSeries, volumeSeries;
        let ma5Series, ma10Series, ma20Series, ma60Series;
        let bollUpperSeries, bollMidSeries, bollLowerSeries;
        let rawData = [];
        let selectedDayIndex = -1;

        let showMA = true;
        let showBOLL = false;
        let showSignals = true;

        // Theme
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function initTheme() {
            const stored = localStorage.getItem('chart-theme');
            applyTheme(stored || getSystemTheme());
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            if (klineChart) updateChartTheme();
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('chart-theme', newTheme);
            applyTheme(newTheme);
        }

        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                background: isDark ? '#0f172a' : '#ffffff',
                textColor: isDark ? '#64748b' : '#888888',
                gridColor: isDark ? '#1e293b' : '#e5e7eb',
            };
        }

        function updateChartTheme() {
            const colors = getChartColors();
            const opts = {
                layout: { background: { color: colors.background }, textColor: colors.textColor },
                grid: { vertLines: { color: colors.gridColor }, horzLines: { color: colors.gridColor } },
            };
            klineChart.applyOptions(opts);
            volumeChart.applyOptions(opts);
        }

        // Calculations
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) continue;
                let sum = 0;
                for (let j = 0; j < period; j++) sum += data[i - j].close;
                result.push({ time: data[i].time, value: sum / period });
            }
            return result;
        }

        function calculateBOLL(data, period = 20, multiplier = 2) {
            const upper = [], mid = [], lower = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) sum += data[i - j].close;
                const avg = sum / period;
                let variance = 0;
                for (let j = 0; j < period; j++) variance += Math.pow(data[i - j].close - avg, 2);
                const std = Math.sqrt(variance / period);
                mid.push({ time: data[i].time, value: avg });
                upper.push({ time: data[i].time, value: avg + multiplier * std });
                lower.push({ time: data[i].time, value: avg - multiplier * std });
            }
            return { upper, mid, lower };
        }

        function detectSignals(data) {
            const signals = [];
            const ma5 = calculateMA(data, 5);
            const ma10 = calculateMA(data, 10);

            for (let i = 1; i < data.length; i++) {
                const time = data[i].time;
                const prevTime = data[i - 1].time;
                const ma5Curr = ma5.find(m => m.time === time)?.value;
                const ma10Curr = ma10.find(m => m.time === time)?.value;
                const ma5Prev = ma5.find(m => m.time === prevTime)?.value;
                const ma10Prev = ma10.find(m => m.time === prevTime)?.value;

                if (ma5Curr && ma10Curr && ma5Prev && ma10Prev) {
                    if (ma5Prev <= ma10Prev && ma5Curr > ma10Curr) {
                        signals.push({ time, position: 'belowBar', color: '#ef4444', shape: 'arrowUp', text: 'ÈáëÂèâ' });
                    }
                    if (ma5Prev >= ma10Prev && ma5Curr < ma10Curr) {
                        signals.push({ time, position: 'aboveBar', color: '#22c55e', shape: 'arrowDown', text: 'Ê≠ªÂèâ' });
                    }
                }
            }
            return signals;
        }

        // Chip Distribution Calculation (based on volume-weighted price distribution)
        function calculateChipDistribution(data, upToIndex) {
            if (!data || data.length === 0) return { distribution: [], avgCost: 0, profitRatio: 0, concentration: 0 };

            const endIndex = upToIndex >= 0 ? upToIndex : data.length - 1;
            const currentPrice = data[endIndex].close;

            // Use last 60 days of data for chip calculation
            const lookback = Math.min(60, endIndex + 1);
            const startIndex = endIndex - lookback + 1;

            // Find price range
            let minPrice = Infinity, maxPrice = -Infinity;
            let totalVolume = 0;

            for (let i = startIndex; i <= endIndex; i++) {
                if (data[i].low < minPrice) minPrice = data[i].low;
                if (data[i].high > maxPrice) maxPrice = data[i].high;
                totalVolume += data[i].volume;
            }

            // Add padding
            const padding = (maxPrice - minPrice) * 0.1;
            minPrice = Math.max(0, minPrice - padding);
            maxPrice = maxPrice + padding;

            // Create price buckets
            const numBuckets = 20;
            const bucketSize = (maxPrice - minPrice) / numBuckets;
            const buckets = new Array(numBuckets).fill(0);

            // Distribute volume into buckets based on price range
            for (let i = startIndex; i <= endIndex; i++) {
                const d = data[i];
                const avgPrice = (d.high + d.low + d.close) / 3;
                const decayFactor = 1 - (endIndex - i) * 0.01; // Recent days have more weight
                const adjustedVolume = d.volume * Math.max(0.3, decayFactor);

                // Distribute across touched price range
                const lowBucket = Math.floor((d.low - minPrice) / bucketSize);
                const highBucket = Math.floor((d.high - minPrice) / bucketSize);

                for (let b = lowBucket; b <= highBucket && b < numBuckets; b++) {
                    if (b >= 0) buckets[b] += adjustedVolume / (highBucket - lowBucket + 1);
                }
            }

            // Normalize and create distribution
            const maxBucket = Math.max(...buckets);
            const distribution = [];
            let profitVolume = 0, lossVolume = 0;
            let weightedSum = 0, totalBucketVolume = 0;

            for (let i = 0; i < numBuckets; i++) {
                const price = minPrice + (i + 0.5) * bucketSize;
                const percentage = maxBucket > 0 ? (buckets[i] / maxBucket) * 100 : 0;
                const isProfit = price <= currentPrice;

                distribution.push({ price, percentage, isProfit });

                if (buckets[i] > 0) {
                    if (isProfit) profitVolume += buckets[i];
                    else lossVolume += buckets[i];
                    weightedSum += price * buckets[i];
                    totalBucketVolume += buckets[i];
                }
            }

            const avgCost = totalBucketVolume > 0 ? weightedSum / totalBucketVolume : currentPrice;
            const profitRatio = (profitVolume + lossVolume) > 0
                ? (profitVolume / (profitVolume + lossVolume)) * 100 : 0;

            // Concentration: measure how spread out the chips are
            const topBuckets = buckets.slice().sort((a, b) => b - a).slice(0, 5);
            const topSum = topBuckets.reduce((a, b) => a + b, 0);
            const totalSum = buckets.reduce((a, b) => a + b, 0);
            const concentration = totalSum > 0 ? (topSum / totalSum) * 100 : 0;

            return { distribution: distribution.reverse(), avgCost, profitRatio, concentration, currentPrice };
        }

        function renderChipDistribution(dayIndex) {
            const displayData = rawData.slice(-currentDays);
            const actualIndex = dayIndex >= 0 ? dayIndex : displayData.length - 1;
            const chips = calculateChipDistribution(displayData, actualIndex);

            const container = document.getElementById('chip-chart');
            container.innerHTML = '';

            const dateStr = displayData[actualIndex]?.time || '--';
            document.getElementById('chipDate').textContent = dateStr;
            document.getElementById('profitRatio').textContent = chips.profitRatio.toFixed(1) + '%';
            document.getElementById('avgCost').textContent = chips.avgCost.toFixed(2);
            document.getElementById('concentration').textContent = chips.concentration.toFixed(1) + '%';

            const wrapper = document.createElement('div');
            wrapper.className = 'chip-bar-container';

            chips.distribution.forEach(item => {
                const row = document.createElement('div');
                row.className = 'chip-bar-row';

                const priceLabel = document.createElement('span');
                priceLabel.className = 'chip-price';
                priceLabel.textContent = item.price.toFixed(1);

                const barWrapper = document.createElement('div');
                barWrapper.className = 'chip-bar-wrapper';

                const bar = document.createElement('div');
                bar.className = 'chip-bar ' + (item.isProfit ? 'profit' : 'loss');
                bar.style.width = item.percentage + '%';

                barWrapper.appendChild(bar);
                row.appendChild(priceLabel);
                row.appendChild(barWrapper);
                wrapper.appendChild(row);
            });

            container.appendChild(wrapper);
        }

        async function loadChart() {
            try {
                const response = await fetch(`${API_BASE}/api/chart/data/${code}?days=${currentDays + 60}&period=${currentPeriod}`);
                if (!response.ok) throw new Error('Failed to load data');

                const result = await response.json();
                if (!result.data || result.data.length === 0) throw new Error('No data available');

                rawData = result.data;

                // Update header
                document.getElementById('stockName').textContent = result.name || code;
                document.getElementById('stockCode').textContent = code;

                const latest = rawData[rawData.length - 1];
                const prev = rawData.length > 1 ? rawData[rawData.length - 2] : latest;
                const change = ((latest.close - prev.close) / prev.close * 100);

                document.getElementById('stockPrice').textContent = latest.close.toFixed(2);
                const changeEl = document.getElementById('stockChange');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeEl.className = `stock-change ${change > 0 ? 'up' : change < 0 ? 'down' : 'flat'}`;

                document.getElementById('loading').style.display = 'none';
                document.getElementById('legend').style.display = 'block';

                createCharts();
                updateChartData();
                renderChipDistribution(-1);

            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        function createCharts() {
            const klineContainer = document.getElementById('kline-container');
            const volumeContainer = document.getElementById('volume-container');

            if (klineChart) klineChart.remove();
            if (volumeChart) volumeChart.remove();

            const colors = getChartColors();
            const chartOpts = {
                layout: { background: { color: colors.background }, textColor: colors.textColor },
                grid: { vertLines: { color: colors.gridColor }, horzLines: { color: colors.gridColor } },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                rightPriceScale: { borderColor: colors.gridColor },
                timeScale: { borderColor: colors.gridColor, timeVisible: true },
            };

            klineChart = LightweightCharts.createChart(klineContainer, {
                ...chartOpts,
                width: klineContainer.clientWidth,
                height: klineContainer.clientHeight,
            });

            volumeChart = LightweightCharts.createChart(volumeContainer, {
                ...chartOpts,
                width: volumeContainer.clientWidth,
                height: volumeContainer.clientHeight,
            });

            candleSeries = klineChart.addCandlestickSeries({
                upColor: '#ef4444', downColor: '#22c55e',
                borderUpColor: '#ef4444', borderDownColor: '#22c55e',
                wickUpColor: '#ef4444', wickDownColor: '#22c55e',
            });

            volumeSeries = volumeChart.addHistogramSeries({
                color: '#22c55e',
                priceFormat: { type: 'volume' },
            });

            ma5Series = klineChart.addLineSeries({ color: '#fbbf24', lineWidth: 1 });
            ma10Series = klineChart.addLineSeries({ color: '#ec4899', lineWidth: 1 });
            ma20Series = klineChart.addLineSeries({ color: '#3b82f6', lineWidth: 1 });

            bollUpperSeries = klineChart.addLineSeries({ color: '#f97316', lineWidth: 1, lineStyle: 2 });
            bollMidSeries = klineChart.addLineSeries({ color: '#3b82f6', lineWidth: 1 });
            bollLowerSeries = klineChart.addLineSeries({ color: '#22c55e', lineWidth: 1, lineStyle: 2 });

            // Sync time scales
            klineChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                if (range) volumeChart.timeScale().setVisibleLogicalRange(range);
            });
            volumeChart.timeScale().subscribeVisibleLogicalRangeChange(range => {
                if (range) klineChart.timeScale().setVisibleLogicalRange(range);
            });

            // Crosshair sync and click handler
            klineChart.subscribeCrosshairMove(param => {
                handleCrosshair(param);
                if (param.time) {
                    volumeChart.setCrosshairPosition(param.point?.y || 0, param.time, volumeSeries);
                }
            });

            // Click to select day for chip distribution
            klineChart.subscribeClick(param => {
                if (param.time) {
                    const displayData = rawData.slice(-currentDays);
                    const idx = displayData.findIndex(d => d.time === param.time);
                    if (idx >= 0) {
                        selectedDayIndex = idx;
                        renderChipDistribution(idx);
                    }
                }
            });

            window.addEventListener('resize', () => {
                klineChart.resize(klineContainer.clientWidth, klineContainer.clientHeight);
                volumeChart.resize(volumeContainer.clientWidth, volumeContainer.clientHeight);
            });
        }

        function updateChartData() {
            const displayData = rawData.slice(-currentDays);

            const candleData = displayData.map(d => ({
                time: d.time, open: d.open, high: d.high, low: d.low, close: d.close,
            }));

            const volumeData = displayData.map(d => ({
                time: d.time,
                value: d.volume,
                color: d.close >= d.open ? 'rgba(239,68,68,0.5)' : 'rgba(34,197,94,0.5)',
            }));

            candleSeries.setData(candleData);
            volumeSeries.setData(volumeData);

            if (showMA) {
                ma5Series.setData(calculateMA(rawData, 5).slice(-currentDays));
                ma10Series.setData(calculateMA(rawData, 10).slice(-currentDays));
                ma20Series.setData(calculateMA(rawData, 20).slice(-currentDays));
                document.getElementById('maLegend').style.display = 'flex';
            } else {
                ma5Series.setData([]);
                ma10Series.setData([]);
                ma20Series.setData([]);
                document.getElementById('maLegend').style.display = 'none';
            }

            if (showBOLL) {
                const boll = calculateBOLL(rawData);
                bollUpperSeries.setData(boll.upper.slice(-currentDays));
                bollMidSeries.setData(boll.mid.slice(-currentDays));
                bollLowerSeries.setData(boll.lower.slice(-currentDays));
            } else {
                bollUpperSeries.setData([]);
                bollMidSeries.setData([]);
                bollLowerSeries.setData([]);
            }

            if (showSignals) {
                const signals = detectSignals(rawData);
                const displaySignals = signals.filter(s => displayData.some(d => d.time === s.time));
                candleSeries.setMarkers(displaySignals);
            } else {
                candleSeries.setMarkers([]);
            }

            klineChart.timeScale().fitContent();
            volumeChart.timeScale().fitContent();
        }

        function handleCrosshair(param) {
            if (!param.time || !param.seriesData) return;
            const candle = param.seriesData.get(candleSeries);
            if (candle) {
                document.getElementById('legO').textContent = candle.open?.toFixed(2) || '--';
                document.getElementById('legH').textContent = candle.high?.toFixed(2) || '--';
                document.getElementById('legL').textContent = candle.low?.toFixed(2) || '--';
                document.getElementById('legC').textContent = candle.close?.toFixed(2) || '--';
            }
            if (showMA) {
                document.getElementById('legMA5').textContent = param.seriesData.get(ma5Series)?.value?.toFixed(2) || '--';
                document.getElementById('legMA10').textContent = param.seriesData.get(ma10Series)?.value?.toFixed(2) || '--';
                document.getElementById('legMA20').textContent = param.seriesData.get(ma20Series)?.value?.toFixed(2) || '--';
            }
        }

        function toggleMA() {
            showMA = !showMA;
            document.getElementById('btnMA').classList.toggle('active', showMA);
            updateChartData();
        }

        function toggleBOLL() {
            showBOLL = !showBOLL;
            document.getElementById('btnBOLL').classList.toggle('active', showBOLL);
            updateChartData();
        }

        function toggleSignals() {
            showSignals = !showSignals;
            document.getElementById('btnSignals').classList.toggle('active', showSignals);
            updateChartData();
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.getElementById('btnDaily').classList.toggle('active', period === 'daily');
            document.getElementById('btnWeekly').classList.toggle('active', period === 'weekly');
            loadChart();
        }

        function setDays(days) {
            currentDays = days;
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                if (['30', '60', '120'].includes(btn.textContent)) {
                    btn.classList.toggle('active', btn.textContent === String(days));
                }
            });
            updateChartData();
            renderChipDistribution(selectedDayIndex);
        }

        initTheme();
        loadChart();

        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }
    </script>
</body>

</html>