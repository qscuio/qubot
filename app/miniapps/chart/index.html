<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stock Chart</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        :root {
            /* Light theme (default) */
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8ecf1;
            --text-primary: #1a1a2e;
            --text-secondary: #666;
            --text-muted: #888;
            --border-color: #d1d5db;
            --btn-bg: #e5e7eb;
            --btn-border: #d1d5db;
            --btn-text: #555;
            --btn-hover-bg: #d1d5db;
            --btn-active-bg: #3b82f6;
            --btn-active-border: #2563eb;
            --btn-active-text: #fff;
            --chart-bg: #ffffff;
            --chart-grid: #e5e7eb;
            --legend-bg: rgba(255, 255, 255, 0.95);
            --up-color: #ef4444;
            --down-color: #22c55e;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #475569;
            --btn-bg: #334155;
            --btn-border: #475569;
            --btn-text: #94a3b8;
            --btn-hover-bg: #475569;
            --btn-active-bg: #3b82f6;
            --btn-active-border: #60a5fa;
            --btn-active-text: #fff;
            --chart-bg: #0f172a;
            --chart-grid: #1e293b;
            --legend-bg: rgba(15, 23, 42, 0.95);
            --up-color: #ef4444;
            --down-color: #22c55e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .header {
            padding: 10px 16px;
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .stock-info {
            display: flex;
            align-items: baseline;
            gap: 12px;
        }

        .stock-name {
            font-size: 18px;
            font-weight: 600;
        }

        .stock-code {
            font-size: 14px;
            color: var(--text-muted);
        }

        .stock-price {
            font-size: 20px;
            font-weight: 600;
        }

        .stock-change {
            font-size: 14px;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .up {
            color: var(--up-color);
            background: rgba(239, 68, 68, 0.15);
        }

        .down {
            color: var(--down-color);
            background: rgba(34, 197, 94, 0.15);
        }

        .flat {
            color: var(--text-muted);
            background: rgba(136, 136, 136, 0.15);
        }

        .toolbar {
            padding: 6px 16px;
            background: var(--bg-secondary);
            display: flex;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-btn {
            padding: 4px 10px;
            font-size: 12px;
            background: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--btn-hover-bg);
            color: var(--text-primary);
        }

        .toolbar-btn.active {
            background: var(--btn-active-bg);
            border-color: var(--btn-active-border);
            color: var(--btn-active-text);
        }

        .toolbar-divider {
            width: 1px;
            height: 20px;
            background: var(--border-color);
            margin: 0 4px;
        }

        .theme-btn {
            padding: 4px 8px;
            font-size: 14px;
            background: var(--btn-bg);
            border: 1px solid var(--btn-border);
            color: var(--btn-text);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: auto;
        }

        .theme-btn:hover {
            background: var(--btn-hover-bg);
        }

        #chart-container {
            width: 100%;
            height: calc(100vh - 100px);
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            font-size: 16px;
            color: var(--text-muted);
        }

        .error {
            color: var(--up-color);
            text-align: center;
            padding: 20px;
        }

        .legend {
            position: absolute;
            top: 110px;
            left: 16px;
            font-size: 11px;
            color: var(--text-muted);
            background: var(--legend-bg);
            padding: 8px 12px;
            border-radius: 4px;
            z-index: 10;
            max-width: 300px;
            border: 1px solid var(--border-color);
        }

        .legend-row {
            display: flex;
            gap: 12px;
            margin-bottom: 3px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            gap: 3px;
        }

        .legend-label {
            color: var(--text-muted);
        }

        .legend-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .ma5 {
            color: #fbbf24;
        }

        .ma10 {
            color: #ec4899;
        }

        .ma20 {
            color: #3b82f6;
        }

        .ma60 {
            color: #a855f7;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="stock-info">
            <span class="stock-name" id="stockName">--</span>
            <span class="stock-code" id="stockCode">--</span>
        </div>
        <div style="display: flex; align-items: baseline; gap: 8px;">
            <span class="stock-price" id="stockPrice">--</span>
            <span class="stock-change flat" id="stockChange">--</span>
        </div>
    </div>
    <div class="toolbar">
        <!-- Period buttons -->
        <button class="toolbar-btn active" id="btnDaily" onclick="setPeriod('daily')">Êó•K</button>
        <button class="toolbar-btn" id="btnWeekly" onclick="setPeriod('weekly')">Âë®K</button>
        <button class="toolbar-btn" id="btnMonthly" onclick="setPeriod('monthly')">ÊúàK</button>
        <div class="toolbar-divider"></div>
        <!-- Indicator buttons -->
        <button class="toolbar-btn active" id="btnMA" onclick="toggleMA()">MA</button>
        <button class="toolbar-btn" id="btnBOLL" onclick="toggleBOLL()">BOLL</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn active" id="btnVol" onclick="toggleVolume()">VOL</button>
        <button class="toolbar-btn" id="btnMACD" onclick="toggleMACD()">MACD</button>
        <div class="toolbar-divider"></div>
        <button class="toolbar-btn active" id="btnSignals" onclick="toggleSignals()">‰ø°Âè∑</button>
        <button class="toolbar-btn" id="btnTrend" onclick="toggleTrend()">Ë∂ãÂäøÁ∫ø</button>
        <div class="toolbar-divider"></div>
        <!-- Days buttons -->
        <button class="toolbar-btn" onclick="setDays(30)">30</button>
        <button class="toolbar-btn active" onclick="setDays(60)">60</button>
        <button class="toolbar-btn" onclick="setDays(120)">120</button>
        <!-- Theme toggle -->
        <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåô</button>
    </div>
    <div id="chart-container">
        <div class="loading" id="loading">Âä†ËΩΩ‰∏≠...</div>
    </div>
    <div class="legend" id="legend" style="display: none;">
        <div class="legend-row">
            <div class="legend-item"><span class="legend-label">O:</span><span class="legend-value" id="legO">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">H:</span><span class="legend-value" id="legH">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">L:</span><span class="legend-value" id="legL">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">C:</span><span class="legend-value" id="legC">--</span>
            </div>
            <div class="legend-item"><span class="legend-label">Vol:</span><span class="legend-value"
                    id="legVol">--</span></div>
        </div>
        <div class="legend-row" id="maLegend">
            <div class="legend-item"><span class="legend-label ma5">MA5:</span><span class="legend-value ma5"
                    id="legMA5">--</span></div>
            <div class="legend-item"><span class="legend-label ma10">MA10:</span><span class="legend-value ma10"
                    id="legMA10">--</span></div>
            <div class="legend-item"><span class="legend-label ma20">MA20:</span><span class="legend-value ma20"
                    id="legMA20">--</span></div>
            <div class="legend-item"><span class="legend-label ma60">MA60:</span><span class="legend-value ma60"
                    id="legMA60">--</span></div>
        </div>
        <div class="legend-row" id="bollLegend" style="display: none;">
            <div class="legend-item"><span class="legend-label" style="color:#f97316">UPPER:</span><span
                    class="legend-value" id="legBollUp">--</span></div>
            <div class="legend-item"><span class="legend-label" style="color:#3b82f6">MID:</span><span
                    class="legend-value" id="legBollMid">--</span></div>
            <div class="legend-item"><span class="legend-label" style="color:#22c55e">LOWER:</span><span
                    class="legend-value" id="legBollLow">--</span></div>
        </div>
    </div>

    <script>
        // Get stock code from URL params
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code') || '600519';
        let currentDays = parseInt(params.get('days')) || 60;
        let currentPeriod = params.get('period') || 'daily';

        // API base URL (same origin)
        const API_BASE = window.location.origin;

        let chart, candleSeries, volumeSeries;
        let ma5Series, ma10Series, ma20Series, ma60Series;
        let bollUpperSeries, bollMidSeries, bollLowerSeries;
        let macdDifSeries, macdDeaSeries, macdHistSeries;
        let rawData = [];

        // State
        let showMA = true;
        let showBOLL = false;
        let showVolume = true;
        let showMACD = false;
        let showSignals = true;
        let showTrend = false;

        // Trend line series
        let supportLine, resistanceLine;

        // Theme management
        function getSystemTheme() {
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        function getStoredTheme() {
            return localStorage.getItem('chart-theme');
        }

        function initTheme() {
            const stored = getStoredTheme();
            const theme = stored || getSystemTheme();
            applyTheme(theme);

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                if (!getStoredTheme()) {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

            // Update chart colors if chart exists
            if (chart) {
                updateChartTheme();
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'light';
            const newTheme = current === 'dark' ? 'light' : 'dark';
            localStorage.setItem('chart-theme', newTheme);
            applyTheme(newTheme);
        }

        function getChartColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                background: isDark ? '#0f172a' : '#ffffff',
                textColor: isDark ? '#64748b' : '#888888',
                gridColor: isDark ? '#1e293b' : '#e5e7eb',
                borderColor: isDark ? '#475569' : '#d1d5db',
            };
        }

        function updateChartTheme() {
            const colors = getChartColors();
            chart.applyOptions({
                layout: {
                    background: { color: colors.background },
                    textColor: colors.textColor,
                },
                grid: {
                    vertLines: { color: colors.gridColor },
                    horzLines: { color: colors.gridColor },
                },
                rightPriceScale: {
                    borderColor: colors.gridColor,
                },
                timeScale: {
                    borderColor: colors.gridColor,
                },
            });
        }

        // Calculate Moving Average
        function calculateMA(data, period) {
            const result = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) {
                    result.push({ time: data[i].time, value: null });
                } else {
                    let sum = 0;
                    for (let j = 0; j < period; j++) {
                        sum += data[i - j].close;
                    }
                    result.push({ time: data[i].time, value: sum / period });
                }
            }
            return result.filter(d => d.value !== null);
        }

        // Calculate Bollinger Bands (20-day, 2 std)
        function calculateBOLL(data, period = 20, multiplier = 2) {
            const upper = [], mid = [], lower = [];
            for (let i = 0; i < data.length; i++) {
                if (i < period - 1) continue;

                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].close;
                }
                const avg = sum / period;

                let variance = 0;
                for (let j = 0; j < period; j++) {
                    variance += Math.pow(data[i - j].close - avg, 2);
                }
                const std = Math.sqrt(variance / period);

                mid.push({ time: data[i].time, value: avg });
                upper.push({ time: data[i].time, value: avg + multiplier * std });
                lower.push({ time: data[i].time, value: avg - multiplier * std });
            }
            return { upper, mid, lower };
        }

        // Calculate MACD (12, 26, 9)
        function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
            const dif = [], dea = [], hist = [];
            let emaFast = null, emaSlow = null, emaDea = null;
            const alphaFast = 2 / (fast + 1);
            const alphaSlow = 2 / (slow + 1);
            const alphaSignal = 2 / (signal + 1);

            for (let i = 0; i < data.length; i++) {
                const close = data[i].close;

                // Initialize EMAs
                if (emaFast === null) {
                    emaFast = close;
                    emaSlow = close;
                } else {
                    emaFast = close * alphaFast + emaFast * (1 - alphaFast);
                    emaSlow = close * alphaSlow + emaSlow * (1 - alphaSlow);
                }

                const difValue = emaFast - emaSlow;

                if (emaDea === null) {
                    emaDea = difValue;
                } else {
                    emaDea = difValue * alphaSignal + emaDea * (1 - alphaSignal);
                }

                const histValue = (difValue - emaDea) * 2;  // Histogram

                if (i >= slow - 1) {
                    dif.push({ time: data[i].time, value: difValue });
                    dea.push({ time: data[i].time, value: emaDea });
                    hist.push({
                        time: data[i].time,
                        value: histValue,
                        color: histValue >= 0 ? 'rgba(239,68,68,0.8)' : 'rgba(34,197,94,0.8)'
                    });
                }
            }
            return { dif, dea, hist };
        }

        // Detect trading signals
        function detectSignals(data) {
            const signals = [];
            const ma5 = calculateMA(data, 5);
            const ma10 = calculateMA(data, 10);
            const macd = calculateMACD(data);
            const boll = calculateBOLL(data);

            // Find indices where MAs are valid
            for (let i = 1; i < data.length; i++) {
                const time = data[i].time;
                const price = data[i].close;
                const low = data[i].low;
                const high = data[i].high;

                // Get MA values for current and previous day
                const ma5Curr = ma5.find(m => m.time === time)?.value;
                const ma10Curr = ma10.find(m => m.time === time)?.value;
                const prevTime = data[i - 1].time;
                const ma5Prev = ma5.find(m => m.time === prevTime)?.value;
                const ma10Prev = ma10.find(m => m.time === prevTime)?.value;

                if (ma5Curr && ma10Curr && ma5Prev && ma10Prev) {
                    // Golden Cross: MA5 crosses above MA10
                    if (ma5Prev <= ma10Prev && ma5Curr > ma10Curr) {
                        signals.push({
                            time: time,
                            position: 'belowBar',
                            color: '#ef4444',
                            shape: 'arrowUp',
                            text: 'ÈáëÂèâ'
                        });
                    }
                    // Death Cross: MA5 crosses below MA10
                    if (ma5Prev >= ma10Prev && ma5Curr < ma10Curr) {
                        signals.push({
                            time: time,
                            position: 'aboveBar',
                            color: '#22c55e',
                            shape: 'arrowDown',
                            text: 'Ê≠ªÂèâ'
                        });
                    }
                }

                // MACD Golden/Death Cross
                const difCurr = macd.dif.find(m => m.time === time)?.value;
                const deaCurr = macd.dea.find(m => m.time === time)?.value;
                const difPrev = macd.dif.find(m => m.time === prevTime)?.value;
                const deaPrev = macd.dea.find(m => m.time === prevTime)?.value;

                if (difCurr !== undefined && deaCurr !== undefined && difPrev !== undefined && deaPrev !== undefined) {
                    // MACD Golden Cross (DIF crosses above DEA)
                    if (difPrev <= deaPrev && difCurr > deaCurr) {
                        signals.push({
                            time: time,
                            position: 'belowBar',
                            color: '#f97316',
                            shape: 'circle',
                            text: 'MÈáë'
                        });
                    }
                    // MACD Death Cross
                    if (difPrev >= deaPrev && difCurr < deaCurr) {
                        signals.push({
                            time: time,
                            position: 'aboveBar',
                            color: '#8b5cf6',
                            shape: 'circle',
                            text: 'MÊ≠ª'
                        });
                    }
                }

                // BOLL breakthrough signals
                const bollUpper = boll.upper.find(b => b.time === time)?.value;
                const bollLower = boll.lower.find(b => b.time === time)?.value;
                const prevClose = data[i - 1].close;
                const bollUpperPrev = boll.upper.find(b => b.time === prevTime)?.value;
                const bollLowerPrev = boll.lower.find(b => b.time === prevTime)?.value;

                if (bollUpper && bollLower && bollUpperPrev && bollLowerPrev) {
                    // Price breaks above upper band (overbought warning)
                    if (prevClose <= bollUpperPrev && price > bollUpper) {
                        signals.push({
                            time: time,
                            position: 'aboveBar',
                            color: '#f59e0b',
                            shape: 'square',
                            text: 'Ë∂Ö‰π∞'
                        });
                    }
                    // Price breaks below lower band (oversold opportunity)
                    if (prevClose >= bollLowerPrev && price < bollLower) {
                        signals.push({
                            time: time,
                            position: 'belowBar',
                            color: '#06b6d4',
                            shape: 'square',
                            text: 'Ë∂ÖÂçñ'
                        });
                    }
                }
            }

            return signals;
        }

        // Calculate support and resistance levels
        function calculateTrendLevels(data) {
            if (data.length < 5) return { support: null, resistance: null };

            // Find recent swing highs and lows
            const lookback = Math.min(20, data.length);
            const recentData = data.slice(-lookback);

            // Simple method: use recent high and low as resistance/support
            let resistance = -Infinity;
            let support = Infinity;

            for (const d of recentData) {
                if (d.high > resistance) resistance = d.high;
                if (d.low < support) support = d.low;
            }

            return { support, resistance };
        }

        async function loadChart() {
            try {
                const response = await fetch(`${API_BASE}/api/chart/data/${code}?days=${currentDays + 60}&period=${currentPeriod}`);
                if (!response.ok) throw new Error('Failed to load data');

                const result = await response.json();

                if (!result.data || result.data.length === 0) {
                    throw new Error('No data available');
                }

                rawData = result.data;

                // Update header
                document.getElementById('stockName').textContent = result.name || code;
                document.getElementById('stockCode').textContent = code;

                // Get latest price info
                const latest = rawData[rawData.length - 1];
                const prev = rawData.length > 1 ? rawData[rawData.length - 2] : latest;
                const change = ((latest.close - prev.close) / prev.close * 100);

                document.getElementById('stockPrice').textContent = latest.close.toFixed(2);
                const changeEl = document.getElementById('stockChange');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)}%`;
                changeEl.className = `stock-change ${change > 0 ? 'up' : change < 0 ? 'down' : 'flat'}`;

                // Hide loading
                document.getElementById('loading').style.display = 'none';
                document.getElementById('legend').style.display = 'block';

                // Create chart
                const container = document.getElementById('chart-container');
                if (chart) chart.remove();

                const colors = getChartColors();
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    layout: {
                        background: { color: colors.background },
                        textColor: colors.textColor,
                    },
                    grid: {
                        vertLines: { color: colors.gridColor },
                        horzLines: { color: colors.gridColor },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: colors.gridColor,
                    },
                    timeScale: {
                        borderColor: colors.gridColor,
                        timeVisible: true,
                    },
                });

                // Candlestick series
                candleSeries = chart.addCandlestickSeries({
                    upColor: '#ef4444',
                    downColor: '#22c55e',
                    borderUpColor: '#ef4444',
                    borderDownColor: '#22c55e',
                    wickUpColor: '#ef4444',
                    wickDownColor: '#22c55e',
                });

                // Volume series
                volumeSeries = chart.addHistogramSeries({
                    color: '#22c55e',
                    priceFormat: { type: 'volume' },
                    priceScaleId: 'volume',
                    scaleMargins: { top: 0.85, bottom: 0 },
                });

                // MA series
                ma5Series = chart.addLineSeries({ color: '#fbbf24', lineWidth: 1, priceScaleId: 'right' });
                ma10Series = chart.addLineSeries({ color: '#ec4899', lineWidth: 1, priceScaleId: 'right' });
                ma20Series = chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, priceScaleId: 'right' });
                ma60Series = chart.addLineSeries({ color: '#a855f7', lineWidth: 1, priceScaleId: 'right' });

                bollUpperSeries = chart.addLineSeries({ color: '#f97316', lineWidth: 1, priceScaleId: 'right', lineStyle: 2 });
                bollMidSeries = chart.addLineSeries({ color: '#3b82f6', lineWidth: 1, priceScaleId: 'right' });
                bollLowerSeries = chart.addLineSeries({ color: '#22c55e', lineWidth: 1, priceScaleId: 'right', lineStyle: 2 });

                // Trend lines
                supportLine = chart.addLineSeries({ color: '#22c55e', lineWidth: 2, priceScaleId: 'right', lineStyle: 1 });
                resistanceLine = chart.addLineSeries({ color: '#ef4444', lineWidth: 2, priceScaleId: 'right', lineStyle: 1 });

                // MACD series (separate scale at bottom)
                macdHistSeries = chart.addHistogramSeries({
                    color: '#22c55e',
                    priceScaleId: 'macd',
                    scaleMargins: { top: 0.85, bottom: 0.02 },
                });
                macdDifSeries = chart.addLineSeries({
                    color: '#fbbf24',
                    lineWidth: 1,
                    priceScaleId: 'macd',
                });
                macdDeaSeries = chart.addLineSeries({
                    color: '#a855f7',
                    lineWidth: 1,
                    priceScaleId: 'macd',
                });

                // Set data
                updateChartData();

                // Crosshair move handler
                chart.subscribeCrosshairMove(handleCrosshair);

                // Fit content
                chart.timeScale().fitContent();

                // Resize handler
                window.addEventListener('resize', () => {
                    chart.resize(container.clientWidth, container.clientHeight);
                });

            } catch (error) {
                document.getElementById('loading').innerHTML = `<div class="error">‚ùå ${error.message}</div>`;
            }
        }

        function updateChartData() {
            // Slice data to current days (use last N days)
            const displayData = rawData.slice(-currentDays);

            const candleData = displayData.map(d => ({
                time: d.time,
                open: d.open,
                high: d.high,
                low: d.low,
                close: d.close,
            }));

            const volumeData = displayData.map(d => ({
                time: d.time,
                value: d.volume,
                color: d.close >= d.open ? 'rgba(239,68,68,0.5)' : 'rgba(34,197,94,0.5)',
            }));

            candleSeries.setData(candleData);

            // Volume
            if (showVolume) {
                volumeSeries.setData(volumeData);
            } else {
                volumeSeries.setData([]);
            }

            // MA indicators (calculated on full data for accuracy)
            if (showMA) {
                ma5Series.setData(calculateMA(rawData, 5).slice(-currentDays));
                ma10Series.setData(calculateMA(rawData, 10).slice(-currentDays));
                ma20Series.setData(calculateMA(rawData, 20).slice(-currentDays));
                ma60Series.setData(calculateMA(rawData, 60).slice(-currentDays));
                document.getElementById('maLegend').style.display = 'flex';
            } else {
                ma5Series.setData([]);
                ma10Series.setData([]);
                ma20Series.setData([]);
                ma60Series.setData([]);
                document.getElementById('maLegend').style.display = 'none';
            }

            // BOLL
            if (showBOLL) {
                const boll = calculateBOLL(rawData);
                bollUpperSeries.setData(boll.upper.slice(-currentDays));
                bollMidSeries.setData(boll.mid.slice(-currentDays));
                bollLowerSeries.setData(boll.lower.slice(-currentDays));
                document.getElementById('bollLegend').style.display = 'flex';
            } else {
                bollUpperSeries.setData([]);
                bollMidSeries.setData([]);
                bollLowerSeries.setData([]);
                document.getElementById('bollLegend').style.display = 'none';
            }

            // MACD
            if (showMACD) {
                const macd = calculateMACD(rawData);
                macdDifSeries.setData(macd.dif.slice(-currentDays));
                macdDeaSeries.setData(macd.dea.slice(-currentDays));
                macdHistSeries.setData(macd.hist.slice(-currentDays));
            } else {
                macdDifSeries.setData([]);
                macdDeaSeries.setData([]);
                macdHistSeries.setData([]);
            }

            // Signals
            if (showSignals) {
                const signals = detectSignals(rawData);
                const displaySignals = signals.filter(s => {
                    const displayTimes = displayData.map(d => d.time);
                    return displayTimes.includes(s.time);
                });
                candleSeries.setMarkers(displaySignals);
            } else {
                candleSeries.setMarkers([]);
            }

            // Trend lines
            if (showTrend) {
                const levels = calculateTrendLevels(displayData);
                if (levels.support && levels.resistance) {
                    const startTime = displayData[0].time;
                    const endTime = displayData[displayData.length - 1].time;
                    supportLine.setData([
                        { time: startTime, value: levels.support },
                        { time: endTime, value: levels.support }
                    ]);
                    resistanceLine.setData([
                        { time: startTime, value: levels.resistance },
                        { time: endTime, value: levels.resistance }
                    ]);
                }
            } else {
                supportLine.setData([]);
                resistanceLine.setData([]);
            }

            chart.timeScale().fitContent();
        }

        function handleCrosshair(param) {
            if (!param.time || !param.seriesData) return;

            const candle = param.seriesData.get(candleSeries);
            const vol = param.seriesData.get(volumeSeries);

            if (candle) {
                document.getElementById('legO').textContent = candle.open?.toFixed(2) || '--';
                document.getElementById('legH').textContent = candle.high?.toFixed(2) || '--';
                document.getElementById('legL').textContent = candle.low?.toFixed(2) || '--';
                document.getElementById('legC').textContent = candle.close?.toFixed(2) || '--';
            }
            if (vol) {
                document.getElementById('legVol').textContent = formatVolume(vol.value);
            }

            // MA values
            if (showMA) {
                const ma5 = param.seriesData.get(ma5Series);
                const ma10 = param.seriesData.get(ma10Series);
                const ma20 = param.seriesData.get(ma20Series);
                const ma60 = param.seriesData.get(ma60Series);
                document.getElementById('legMA5').textContent = ma5?.value?.toFixed(2) || '--';
                document.getElementById('legMA10').textContent = ma10?.value?.toFixed(2) || '--';
                document.getElementById('legMA20').textContent = ma20?.value?.toFixed(2) || '--';
                document.getElementById('legMA60').textContent = ma60?.value?.toFixed(2) || '--';
            }

            // BOLL values
            if (showBOLL) {
                const bu = param.seriesData.get(bollUpperSeries);
                const bm = param.seriesData.get(bollMidSeries);
                const bl = param.seriesData.get(bollLowerSeries);
                document.getElementById('legBollUp').textContent = bu?.value?.toFixed(2) || '--';
                document.getElementById('legBollMid').textContent = bm?.value?.toFixed(2) || '--';
                document.getElementById('legBollLow').textContent = bl?.value?.toFixed(2) || '--';
            }
        }

        function toggleMA() {
            showMA = !showMA;
            document.getElementById('btnMA').classList.toggle('active', showMA);
            updateChartData();
        }

        function toggleBOLL() {
            showBOLL = !showBOLL;
            document.getElementById('btnBOLL').classList.toggle('active', showBOLL);
            updateChartData();
        }

        function toggleVolume() {
            showVolume = !showVolume;
            document.getElementById('btnVol').classList.toggle('active', showVolume);
            updateChartData();
        }

        function toggleMACD() {
            showMACD = !showMACD;
            document.getElementById('btnMACD').classList.toggle('active', showMACD);
            updateChartData();
        }

        function toggleSignals() {
            showSignals = !showSignals;
            document.getElementById('btnSignals').classList.toggle('active', showSignals);
            updateChartData();
        }

        function toggleTrend() {
            showTrend = !showTrend;
            document.getElementById('btnTrend').classList.toggle('active', showTrend);
            updateChartData();
        }

        function setPeriod(period) {
            currentPeriod = period;
            document.getElementById('btnDaily').classList.toggle('active', period === 'daily');
            document.getElementById('btnWeekly').classList.toggle('active', period === 'weekly');
            document.getElementById('btnMonthly').classList.toggle('active', period === 'monthly');
            loadChart();
        }

        function setDays(days) {
            currentDays = days;
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                const text = btn.textContent;
                if (['30', '60', '120'].includes(text)) {
                    btn.classList.toggle('active', text === String(days));
                }
            });
            updateChartData();
        }

        function formatVolume(vol) {
            if (vol >= 100000000) return (vol / 100000000).toFixed(2) + '‰∫ø';
            if (vol >= 10000) return (vol / 10000).toFixed(0) + '‰∏á';
            return vol.toString();
        }

        // Initialize theme first
        initTheme();

        // Initialize chart
        loadChart();

        // Telegram WebApp integration
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
        }
    </script>
</body>

</html>